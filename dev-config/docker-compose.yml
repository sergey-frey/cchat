# version: '3.8'
# services:
# client:
#   build:
#     # Поскольку docker-compose не в корне client,
#     # нужно указать context с путём до client относительно docker-compose
#     context: ../client
#     # Путь до Dockerfile здесь указывается относительно context
#     dockerfile: ../dev-config/Dockerfile.client
#   ports:
#     - '5173:5173'

#   volumes:
#     # Связываем локальную директорию с директорией в контейнере для hot reload'а
#     - ../client:/usr/app
#     - /usr/app/node_modules

#   environment:
#     - MODE=develop

#   command: bash -c "npm install && npm run dev"
# auth-service:
#   build:
#     context: ../server/auth-service
#     dockerfile: ./Dockerfile
#   command: ./wait-for-db.sh auth-postgres ./auth-service
#   environment:
#     - PG_DB_PASSWORD=qwerty
#   ports:
#     - 3010:3010
#   depends_on:
#     - auth-postgres
# auth-postgres:
#   restart: always
#   image: postgres:16-alpine
#   environment:
#     - POSTGRES_PASSWORD=qwerty
#   ports:
#     - 3310:5432
# user-service:
#   build:
#     context: ../server/user-service
#     dockerfile: ./Dockerfile
#   command: ./wait-for-db.sh user-postgres ./user-service
#   environment:
#     - PG_DB_PASSWORD=qwerty
#   ports:
#     - 3040:3040
#   depends_on:
#     - user-postgres
# user-postgres:
#   restart: always
#   image: postgres:16-alpine
#   environment:
#     - POSTGRES_PASSWORD=qwerty
#   ports:
#     - 3340:5432
# chat-service:
#   build:
#     context: ../server/chat-service
#     dockerfile: ./Dockerfile
#   command: ./wait-for-db.sh chat-postgres ./chat-service
#   environment:
#     - PG_DB_PASSWORD=qwerty
#   ports:
#     - 8040:8040
#   depends_on:
#     - chat-postgres
# chat-postgres:
#   restart: always
#   image: postgres:16-alpine
#   environment:
#     - POSTGRES_PASSWORD=qwerty
#   ports:
#     - 3320:5432

#TODO:

# version: '3.8'

# networks:
#   frontend:
#   backend:

# services:
#   gateway:
#     image: nginx:latest
#     container_name: nginx-gateway
#     ports:
#       - "80:80"
#     volumes:
#       - ../server/nginx-gateway/nginx.conf:/etc/nginx/nginx.conf
#     depends_on:
#       - auth-service
#       - users-service-1
#       - users-service-2
#       - chats-service
#     networks:
#       - frontend

#   auth-service:
#     build:
#       context: ../server/auth-service
#       dockerfile: ./Dockerfile
#     container_name: auth-service
#     command: ./wait-for-db.sh auth-db ./auth-service
#     environment:
#       - DB_HOST=auth-db
#       - DB_PORT=5432
#       - DB_USER=user
#       - DB_PASSWORD=password
#       - DB_NAME=authdb
#       - USERS_SERVICE_1_URL=http://users-service-1:8080
#       - USERS_SERVICE_2_URL=http://users-service-2:8080
#     depends_on:
#       - auth-db
#     networks:
#       - frontend
#       - backend

#   auth-db:
#     image: postgres:16-alpine
#     container_name: auth-db
#     environment:
#       - POSTGRES_USER=user
#       - POSTGRES_PASSWORD=password
#       - POSTGRES_DB=authdb
#     volumes:
#       - auth-db-data:/var/lib/postgresql/data
#     networks:
#       - backend
#     healthcheck:
#       # Команда pg_isready очень легкая и создана специально для таких проверок
#       test: ["CMD-SHELL", "pg_isready -U user -d authdb"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   users-service-1:
#     build:
#       context: ../server/user-service
#       dockerfile: ./Dockerfile
#     container_name: users-service-1
#     command: ./wait-for-db.sh users-db ./users-service
#     environment:
#       - DB_HOST=users-db
#       - DB_PORT=5432
#       - DB_USER=user
#       - DB_PASSWORD=password
#       - DB_NAME=usersdb
#       - REPLICA_ID=instance-1
#       - AUTH_SERVICE_URL=http://auth-service:8080
#     depends_on:
#       - users-db
#     networks:
#       - frontend
#       - backend

#   users-service-2:
#     build:
#       context: ../server/user-service
#       dockerfile: ./Dockerfile
#     container_name: users-service-2
#     command: ./wait-for-db.sh users-db ./users-service
#     environment:
#       - DB_HOST=users-db
#       - DB_PORT=5432
#       - DB_USER=user
#       - DB_PASSWORD=password
#       - DB_NAME=usersdb
#       - REPLICA_ID=instance-2
#       - AUTH_SERVICE_URL=http://auth-service:8080
#     depends_on:
#       - users-db
#     networks:
#       - frontend
#       - backend

#   users-db:
#     image: postgres:16-alpine
#     container_name: users-db
#     environment:
#       - POSTGRES_USER=user
#       - POSTGRES_PASSWORD=password
#       - POSTGRES_DB=usersdb
#     volumes:
#       - users-db-data:/var/lib/postgresql/data
#     networks:
#       - backend
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U user -d usersdb"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   chats-service:
#     build:
#       context: ../server/chat-service
#       dockerfile: ./Dockerfile
#     container_name: chats-service
#     command: ./wait-for-db.sh chats-db ./chats-service
#     environment:
#       - DB_HOST=chats-db
#       - DB_PORT=5432
#       - DB_USER=user
#       - DB_PASSWORD=password
#       - DB_NAME=chatsdb
#     depends_on:
#       - chats-db
#     networks:
#       - frontend
#       - backend

#   chats-db:
#     image: postgres:16-alpine
#     container_name: chats-db
#     environment:
#       - POSTGRES_USER=user
#       - POSTGRES_PASSWORD=password
#       - POSTGRES_DB=chatsdb
#     volumes:
#       - chats-db-data:/var/lib/postgresql/data
#     networks:
#       - backend
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U user -d chatsdb"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   pgadmin:
#     image: dpage/pgadmin4
#     container_name: pgadmin
#     environment:
#       - PGADMIN_DEFAULT_EMAIL=admin@example.com
#       - PGADMIN_DEFAULT_PASSWORD=admin
#     ports:
#       - "5050:80"
#     depends_on:
#       - auth-db
#       - users-db
#       - chats-db
#     networks:
#       - backend

# volumes:
#   auth-db-data:
#   users-db-data:
#   chats-db-data:

#TODO:

version: '3.8'

services:
  gateway:
    image: nginx:latest
    container_name: nginx-gateway
    ports:
      - "80:80"
    volumes:
      - ../server/nginx-gateway/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - auth-service
      - users-service-1
      - users-service-2
      - chats-service
    networks:
      - frontend

  auth-service:
    build:
      context: ../server/auth-service
    container_name: auth-service
    command: ./wait-for-db.sh auth-db ./auth-service # Ваш скрипт ожидания
    environment:
      - DB_HOST=auth-db
      - DB_USER=user
      - DB_PORT=5432
      - DB_PASSWORD=password
      - DB_NAME=authdb
      - USERS_SERVICE_1_URL=http://users-service-1:8080
      - USERS_SERVICE_2_URL=http://users-service-2:8080
    depends_on:
      # ИСПРАВЛЕНО: Теперь сервис ждет, пока БД будет полностью готова
      auth-db:
        condition: service_healthy
      # УДАЛЕНО: Убираем циклическую зависимость от user-сервисов
    networks:
      - frontend
      - backend

  users-service-1:
    build:
      context: ../server/user-service
    container_name: users-service-1
    command: ./wait-for-db.sh users-db ./users-service
    environment:
      - DB_HOST=users-db
      - DB_USER=user
      - DB_PORT=5432
      - DB_PASSWORD=password
      - DB_NAME=usersdb
      - REPLICA_ID=instance-1
      - AUTH_SERVICE_URL=http://auth-service:8080
    depends_on:
      # ИСПРАВЛЕНО: Ждем готовности БД
      users-db:
        condition: service_healthy
    networks:
      - frontend
      - backend

  users-service-2:
    build:
      context: ../server/user-service
    container_name: users-service-2
    command: ./wait-for-db.sh users-db ./users-service
    environment:
      - DB_HOST=users-db
      - DB_USER=user
      - DB_PORT=5432
      - DB_PASSWORD=password
      - DB_NAME=usersdb
      - REPLICA_ID=instance-2
      - AUTH_SERVICE_URL=http://auth-service:8080
    depends_on:
      # ИСПРАВЛЕНО: Ждем готовности БД
      users-db:
        condition: service_healthy
    networks:
      - frontend
      - backend

  chats-service:
    build:
      context: ../server/chat-service
    container_name: chats-service
    command: ./wait-for-db.sh chats-db ./chats-service
    environment:
      - DB_HOST=chats-db
      - DB_USER=user
      - DB_PORT=5432
      - DB_PASSWORD=password
      - DB_NAME=chatsdb
    depends_on:
      # ИСПРАВЛЕНО: Ждем готовности БД
      chats-db:
        condition: service_healthy
    networks:
      - frontend
      - backend

  # --- Базы данных ---
  auth-db:
    image: postgres:16-alpine
    container_name: auth-db
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=authdb
    volumes:
      - auth-db-data:/var/lib/postgresql/data
      # ИСПРАВЛЕНО: Корректный путь к init-скрипту
      #- ../server/auth-service/init:/docker-entrypoint-initdb.d
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d authdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  users-db:
    image: postgres:16-alpine
    container_name: users-db
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=usersdb
    volumes:
      - users-db-data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d usersdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  chats-db:
    image: postgres:16-alpine
    container_name: chats-db
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=chatsdb
    volumes:
      - chats-db-data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d chatsdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=admin
    ports:
      - "5050:80"
    depends_on: # Для pgadmin достаточно простого depends_on
      - auth-db
      - users-db
      - chats-db
    networks:
      - backend

networks:
  frontend:
  backend:

volumes:
  auth-db-data:
  users-db-data:
  chats-db-data: