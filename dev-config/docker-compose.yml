services:
  client:
    build:
      # Поскольку docker-compose не в корне client,
      # нужно указать context с путём до client относительно docker-compose
      context: ../client
      # Путь до Dockerfile здесь указывается относительно context
      dockerfile: ../dev-config/Dockerfile.client
    ports:
      - "5173:5173"

    volumes:
      # Связываем локальную директорию с директорией в контейнере для hot reload'а
      - ../client:/usr/app
      - /usr/app/node_modules

    environment:
      - MODE=develop

    command: bash -c "npm install && npm run dev"
  cchat-server-app:
    build:
      context: ../server
      dockerfile: "../dev-config/Dockerfile.server"
    # Bash в контейнере может не распознавать wait-for-postgres.sh из-за CRLF
    # В таком случае можно изменить формат - `dos2unix ../server/wait-for-postgres.sh`
    command: ./wait-for-postgres.sh psql ./cchat-server-app
    ports:
      - 8040:8040
    depends_on:
      - psql
    environment:
      - DB_PASSWORD=qwerty
  psql:
    restart: always
    image: postgres:latest
    environment:
      - POSTGRES_PASSWORD=qwerty
    ports:
      - 5443:5432
